{% extends "layout.html" %}
{% block content %}
{% if ticket %}
<h3>Lập phiếu sửa chữa: {{ ticket.xe.bien_so }}</h3>
<div class="row">
    <div class="col-md-6">
        <input type="text" class="form-control mb-2" placeholder="Tìm phụ tùng..." oninput="tim(this.value)">
        <div id="list" class="list-group" style="height:300px;overflow-y:auto"></div>
    </div>
    <div class="col-md-6">
        <div class="card p-3">
            <h5>Vật tư đã chọn</h5>
            <ul id="cart" class="list-group mb-3"></ul>
            <form method="post">
                <label>Tiền công (VNĐ)</label>
                <input type="number" name="labor" class="form-control mb-3" value="0">
                <button class="btn btn-danger w-100">Hoàn tất sửa chữa</button>
            </form>
        </div>
    </div>
</div>
<script>
function tim(kw){
    fetch(`/api/parts?kw=${kw}`).then(r=>r.json()).then(d=>{
        let h=''; d.forEach(p=>h+=`<button type="button" onclick="add(${p.id},'${p.ten}',${p.gia})" class="list-group-item list-group-item-action">${p.ten} - ${p.gia.toLocaleString()} đ (Kho: ${p.ton})</button>`);
        document.getElementById('list').innerHTML=h;
    })
}
function add(id,n,p){
    fetch('/api/cart',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:id,name:n,price:p})})
    .then(r=>r.json()).then(c=>{
        let h=''; for(k in c) h+=`<li class="list-group-item d-flex justify-content-between"><span>${c[k].name}</span><span>x${c[k].quantity}</span></li>`;
        document.getElementById('cart').innerHTML=h;
    })
}
tim('');
</script>
{% else %}
<div class="alert alert-warning">Chưa chọn xe nào để sửa!</div>
{% endif %}
{% endblock %}
