{% extends "layout.html" %}
{% block content %}
<div class="fade-in">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
            <i class="fa-solid fa-file-pen mr-3 text-blue-600"></i>Tiếp nhận xe mới
        </h2>
        <div class="flex items-center space-x-3">
            <div class="text-sm bg-white px-4 py-2 rounded-lg shadow-sm border border-gray-200">
                <span class="text-gray-500">Giới hạn ngày:</span>
                <span class="font-bold {{ 'text-red-600' if tickets|length >= 30 else 'text-blue-600' }} text-lg ml-1">{{ tickets|length }}/30</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="lg:col-span-1 space-y-6">

            {% if db_error %}
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-md shadow-sm animate-pulse">
                <div class="flex">
                    <div class="flex-shrink-0"><i class="fa-solid fa-circle-exclamation text-red-500"></i></div>
                    <div class="ml-3 w-full">
                        <p class="text-sm text-red-700 font-bold mb-2">Lỗi hệ thống: {{ db_error }}</p>
                        <div class="flex justify-between">
                            <a href="/reception" class="text-sm text-gray-600 underline hover:text-gray-800">Hủy bỏ</a>
                            <button onclick="document.getElementById('receptionForm').submit()"
                                    class="text-sm bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded font-bold transition">
                                Thử lại
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if limit_reached %}
            <div class="bg-amber-50 border-l-4 border-amber-400 p-6 rounded-md shadow-sm text-center">
                <i class="fa-solid fa-ban text-amber-500 text-4xl mb-3"></i>
                <h3 class="text-lg font-bold text-amber-800">Đã đạt giới hạn!</h3>
                <p class="text-sm text-amber-700">Hôm nay gara đã nhận đủ số lượng xe quy định.</p>
            </div>
            {% else %}

            <form method="post" id="receptionForm"
                  class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-5 border-b border-gray-100 bg-gray-50">
                    <h3 class="font-bold text-gray-800"><i class="fa-solid fa-pen-to-square mr-2 text-blue-500"></i>Thông
                        tin phiếu</h3>
                </div>

                <div class="p-5 space-y-4">
                    <div>
                        <label class="block mb-1 text-xs font-bold text-gray-500 uppercase tracking-wide">Biển số xe
                            <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="text" name="plate" id="plate"
                                   class="w-full bg-gray-50 border {{ 'border-red-500 bg-red-50' if errors and errors.plate else 'border-gray-300' }} text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-bold uppercase"
                                   placeholder="VD: 59X1-12345"
                                   value="{{ form_data.plate if form_data else '' }}" required onblur="checkPlate()">
                            <p id="plate-msg" class="mt-1 text-xs h-4"></p>
                            {% if errors and errors.plate %}
                            <p class="text-xs text-red-600 font-bold mt-1"><i
                                    class="fa-solid fa-circle-exclamation mr-1"></i>{{ errors.plate }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <div>
                        <label class="block mb-1 text-xs font-bold text-gray-500 uppercase tracking-wide">Hãng xe <span
                                class="text-red-500">*</span></label>
                        <input type="text" name="brand" id="brand"
                               class="w-full bg-gray-50 border {{ 'border-red-500 bg-red-50' if errors and errors.brand else 'border-gray-300' }} text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                               placeholder="Chọn hãng..." list="brandList"
                               value="{{ form_data.brand if form_data else '' }}">
                        <datalist id="brandList">
                            {% for b in valid_brands %}
                            <option value="{{ b }}">{% endfor %}
                        </datalist>
                        {% if errors and errors.brand %}
                        <p class="mt-1 text-xs text-red-600 font-bold mt-1">{{ errors.brand }}</p>
                        {% endif %}
                    </div>

                    <div class="border-t border-gray-100 my-2"></div>

                    <div>
                        <label class="block mb-1 text-xs font-bold text-gray-500 uppercase tracking-wide">Số điện thoại
                            <span class="text-red-500">*</span></label>
                        <input type="text" name="phone" id="phone"
                               class="w-full bg-gray-50 border {{ 'border-red-500 bg-red-50' if errors and errors.phone else 'border-gray-300' }} text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                               placeholder="10 chữ số (0...)"
                               value="{{ form_data.phone if form_data else '' }}" required onblur="checkPhone()">
                        <p id="phone-msg" class="mt-1 text-xs h-4"></p>
                        {% if errors and errors.phone %}
                        <p class="text-xs text-red-600 font-bold mt-1">{{ errors.phone }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block mb-1 text-xs font-bold text-gray-500 uppercase tracking-wide">Tên khách hàng
                            <span class="text-red-500">*</span></label>
                        <input type="text" name="name" id="name"
                               class="w-full bg-gray-50 border {{ 'border-red-500 bg-red-50' if errors and errors.name else 'border-gray-300' }} text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-medium"
                               value="{{ form_data.name if form_data else '' }}" required>
                        {% if errors and errors.name %}
                        <p class="mt-1 text-xs text-red-600 font-bold mt-1">{{ errors.name }}</p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block mb-1 text-xs font-bold text-gray-500 uppercase tracking-wide">Địa
                            chỉ</label>
                        <input type="text" name="address" id="address"
                               class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                               value="{{ form_data.address if form_data else '' }}">
                    </div>

                    <div>
                        <label class="block mb-1 text-xs font-bold text-gray-500 uppercase tracking-wide">
                            <i class="fa-solid fa-screwdriver-wrench mr-1"></i> Loại dịch vụ / Mô tả lỗi <span
                                class="text-red-500">*</span>
                        </label>

                        <input type="text" name="issue" list="commonIssues" required
                               class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                               placeholder="Chọn hoặc nhập lỗi..."
                               value="{{ form_data.issue if form_data else '' }}">

                        <datalist id="commonIssues">
                            <option value="Bảo dưỡng định kỳ">
                            <option value="Thay nhớt & Lọc">
                            <option value="Vệ sinh khoang máy">

                            <option value="Hệ thống Phanh (Thắng)">
                            <option value="Hệ thống Gầm & Phuộc">
                            <option value="Cân bằng động & Lốp xe">

                            <option value="Động cơ & Máy">
                            <option value="Hệ thống Điện & Đèn">
                            <option value="Hệ thống Lạnh (Điều hòa)">
                            <option value="Bình ắc quy">

                            <option value="Đồng sơn & Vết xước">
                            <option value="Thay thế phụ tùng thân vỏ">

                            <option value="Đăng kiểm & Giấy tờ">
                            <option value="Cứu hộ & Kéo xe">
                        </datalist>

                        <p class="text-xs text-gray-500 mt-1 italic">
                            * Gợi ý: Chọn mục có sẵn để báo cáo chính xác hơn.
                        </p>
                    </div>

                </div>

                <div class="p-5 border-t border-gray-100 bg-gray-50">
                    <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all flex justify-center items-center">
                        <i class="fa-regular fa-floppy-disk mr-2"></i> LƯU PHIẾU TIẾP NHẬN
                    </button>
                </div>
            </form>
            {% endif %}
        </div>

        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 h-full flex flex-col">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h3 class="font-bold text-lg text-gray-800"><i
                            class="fa-solid fa-list-check mr-2 text-gray-500"></i>Danh sách xe hôm nay</h3>
                </div>

                <div class="overflow-x-auto flex-1">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0">
                        <tr>
                            <th class="px-6 py-3">Biển số</th>
                            <th class="px-6 py-3">Khách hàng</th>
                            <th class="px-6 py-3 hidden md:table-cell">SĐT</th>
                            <th class="px-6 py-3">Giờ nhận</th>
                            <th class="px-6 py-3 text-center">Trạng thái</th>
                            <th class="px-6 py-3 text-center">Tác vụ</th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                        {% for t in tickets %}
                        <tr class="bg-white hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 font-bold text-blue-600">{{ t.xe.bien_so }}</td>
                            <td class="px-6 py-4 font-medium text-gray-900">{{ t.xe.khach_hang.ten }}</td>
                            <td class="px-6 py-4 hidden md:table-cell text-gray-500">{{ t.xe.khach_hang.dien_thoai }}
                            </td>
                            <td class="px-6 py-4 text-xs">{{ t.ngay_tiep_nhan.strftime('%H:%M') }}</td>
                            <td class="px-6 py-4 text-center">
                                {% if t.trang_thai.name == 'CHO_SUA' %}
                                <span class="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2.5 py-0.5 rounded border border-yellow-200">Chờ sửa</span>
                                {% elif t.trang_thai.name == 'DANG_SUA' %}
                                <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded border border-blue-200">Đang sửa</span>
                                {% else %}
                                <span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded border border-green-200">Đã xong</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if t.trang_thai.name == 'CHO_SUA' and current_user.vai_tro.name in ['KY_THUAT',
                                'ADMIN'] %}
                                <a href="/repair?id={{ t.id }}"
                                   class="text-blue-600 hover:text-blue-900 bg-blue-50 hover:bg-blue-100 px-3 py-1 rounded text-xs font-bold transition">
                                    Sửa <i class="fa-solid fa-wrench ml-1"></i>
                                </a>
                                {% else %}
                                <span class="text-gray-300">--</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="px-6 py-10 text-center text-gray-400">
                                <div class="flex flex-col items-center">
                                    <i class="fa-solid fa-clipboard-list text-4xl mb-3 opacity-20"></i>
                                    <p>Chưa có phiếu nào hôm nay.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% if new_ticket %}
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 fade-in" id="printModal">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-md mx-4 overflow-hidden transform scale-100 transition-transform">
        <div class="bg-green-600 text-white px-6 py-4 flex justify-between items-center">
            <h3 class="font-bold text-lg"><i class="fa-solid fa-check-circle mr-2"></i>Tiếp nhận thành công!</h3>
            <button onclick="closeModal()" class="text-white hover:text-gray-200"><i
                    class="fa-solid fa-times text-xl"></i></button>
        </div>
        <div class="p-6 text-center">
            <div class="mb-4 text-green-500">
                <i class="fa-solid fa-print text-6xl"></i>
            </div>
            <p class="text-gray-600 mb-1">Đã tạo phiếu tiếp nhận cho xe</p>
            <h2 class="text-3xl font-bold text-blue-600 mb-4">{{ new_ticket.xe.bien_so }}</h2>
            <p class="text-sm text-gray-500">Bạn có muốn in phiếu tiếp nhận ngay bây giờ không?</p>
        </div>
        <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
            <button onclick="closeModal()"
                    class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                Đóng
            </button>
            <button onclick="printTicket()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-sm flex items-center">
                <i class="fa-solid fa-print mr-2"></i> In Phiếu
            </button>
        </div>
    </div>
</div>

<div id="printArea" class="hidden">
    <div style="font-family: monospace; width: 300px; margin: 0 auto; border: 1px solid #000; padding: 10px;">
        <div style="text-align: center;">
            <h3 style="margin: 0; font-size: 20px; font-weight: bold;">GARAGE OTO PRO</h3>
            <p style="margin: 5px 0; font-size: 12px;">ĐC: 123 Đường ABC, TP.HCM</p>
            <hr style="border-top: 1px dashed #000; margin: 10px 0;">
            <h4 style="margin: 10px 0; font-size: 16px; font-weight: bold;">PHIẾU TIẾP NHẬN</h4>
        </div>
        <div style="font-size: 14px; line-height: 1.5;">
            <p><strong>Ngày:</strong> {{ new_ticket.ngay_tiep_nhan.strftime('%d/%m/%Y %H:%M') }}</p>
            <p><strong>Biển số:</strong> {{ new_ticket.xe.bien_so }}</p>
            <p><strong>Hãng xe:</strong> {{ new_ticket.xe.hieu_xe }}</p>
            <p><strong>Khách hàng:</strong> {{ new_ticket.xe.khach_hang.ten }}</p>
            <p><strong>SĐT:</strong> {{ new_ticket.xe.khach_hang.dien_thoai }}</p>
            <hr style="border-top: 1px dashed #000; margin: 10px 0;">
            <p><strong>Yêu cầu:</strong><br>{{ new_ticket.tinh_trang }}</p>
        </div>
        <div style="text-align: center; margin-top: 20px; font-size: 12px;">
            <p>Cảm ơn quý khách!</p>
        </div>
    </div>
</div>
{% endif %}

<script>
    function checkPlate() {
        let plateInput = document.getElementById('plate');
        let plate = plateInput.value;
        if (!plate) return;

        fetch('/api/check-plate', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({plate: plate}) })
        .then(res => res.json()).then(data => {
            let msg = document.getElementById('plate-msg');
            if (data.found) {
                document.getElementById('brand').value = data.hieu_xe || '';
                document.getElementById('phone').value = data.khach_hang.dien_thoai || '';
                document.getElementById('name').value = data.khach_hang.ten || '';
                document.getElementById('address').value = data.khach_hang.dia_chi || '';

                plateInput.classList.remove('border-gray-300');
                plateInput.classList.add('border-green-500', 'bg-green-50');
                msg.innerHTML = '<span class="text-green-600 font-bold flex items-center"><i class="fa-solid fa-circle-check mr-1"></i> Xe cũ (Đã điền thông tin)</span>';
            } else {
                plateInput.classList.remove('border-gray-300');
                plateInput.classList.add('border-blue-500', 'bg-blue-50');
                msg.innerHTML = '<span class="text-blue-600 font-bold flex items-center"><i class="fa-solid fa-circle-info mr-1"></i> Xe mới. Vui lòng nhập thông tin.</span>';
            }
        });
    }

    function checkPhone() {
        let phoneInput = document.getElementById('phone');
        let phone = phoneInput.value;
        if (!phone) return;

        fetch('/api/check-phone', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({phone: phone}) })
        .then(res => res.json()).then(data => {
            let msg = document.getElementById('phone-msg');
            if (data.found) {
                document.getElementById('name').value = data.ten;
                document.getElementById('address').value = data.dia_chi;

                phoneInput.classList.remove('border-gray-300');
                phoneInput.classList.add('border-green-500', 'bg-green-50');
                msg.innerHTML = '<span class="text-green-600 font-bold flex items-center"><i class="fa-solid fa-user-check mr-1"></i> Khách quen</span>';
            } else {
                phoneInput.classList.remove('border-gray-300');
                phoneInput.classList.add('border-blue-500', 'bg-blue-50');
                msg.innerHTML = '<span class="text-blue-600 font-bold flex items-center"><i class="fa-solid fa-user-plus mr-1"></i> Khách mới</span>';
            }
        });
    }

    function closeModal() {
        document.getElementById('printModal').style.display = 'none';
    }

    function printTicket() {
        var content = document.getElementById('printArea').innerHTML;
        var myWindow = window.open('', '', 'width=450,height=600');
        myWindow.document.write('<html><head><title>Print</title></head><body onload="window.print();window.close()">');
        myWindow.document.write(content);
        myWindow.document.write('</body></html>');
        myWindow.document.close();
    }
</script>
{% endblock %}